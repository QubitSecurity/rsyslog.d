module(load="imudp")
input(type="imudp" port="514")

module(load="imtcp")
input(type="imtcp" port="514")

# 파일 경로 템플릿
template(name="DynFile" type="string"
  string="/var/log/plura/ceelog-%$.origip%.log"
)

# JSON 출력 템플릿 (re_replace 대신 $.cleanmsg 변수 활용)
template(name="CeelogJSONClean" type="string"
  string="{\"ceelog\":{\"timegenerated\":\"%timegenerated:::date-rfc3339%\",\"programname\":\"%programname%\",\"hostname\":\"%hostname%\",\"syslogtag\":\"%syslogtag%\",\"pri\":\"%pri%\",\"pri-text\":\"%pri-text%\",\"syslogfacility\":\"%syslogfacility%\",\"syslogfacility-text\":\"%syslogfacility-text%\",\"syslogseverity\":\"%syslogseverity%\",\"syslogseverity-text\":\"%syslogseverity-text%\",\"msg\":\"%$.cleanmsg%\"}}\n"
)

# origip 추출 및 처리
if ($msg contains "origip=") then {
    set $.origip = re_extract($msg, "origip=([0-9.]+)", 0, 1, "unknown");
    
    # re_replace 대신 원본 메시지를 저장하거나, 
    # 정규표현식이 꼭 필요하다면 추후 mmnormalize 모듈 설치를 권장합니다.
    set $.cleanmsg = $msg; 

    if ($.origip != "unknown") then {
        action(
            type="omfile"
            dynaFile="DynFile"
            template="CeelogJSONClean"
            dirCreateMode="0755"
            fileCreateMode="0644"
        )
        stop
    }
}

# fallback: origip 없거나 추출 실패 시
action(
  type="omfile"
  file="/var/log/plura/ceelog-unknown.log"
  dirCreateMode="0755"
  fileCreateMode="0644"
)
stop
