module(load="imudp")
input(type="imudp" port="514")

module(load="imtcp")
input(type="imtcp" port="514")

template(name="DynFile" type="string"
  string="/var/log/plura/ceelog-%$.origip%.log"
)

template(name="CeelogJSONClean" type="string"
  string="{\"ceelog\":{\"timegenerated\":\"%timegenerated:::date-rfc3339%\",\"programname\":\"%programname%\",\"hostname\":\"%hostname%\",\"syslogtag\":\"%syslogtag%\",\"pri\":\"%pri%\",\"pri-text\":\"%pri-text%\",\"syslogfacility\":\"%syslogfacility%\",\"syslogfacility-text\":\"%syslogfacility-text%\",\"syslogseverity\":\"%syslogseverity%\",\"syslogseverity-text\":\"%syslogseverity-text%\",\"msg\":\"%$.cleanmsg:json%\"}}\n"
)

# origip가 있으면: origip 추출 -> prefix 제거 -> origip 파일로 저장
if ($msg contains "origip=") then {
    set $.origip    = re_extract($msg, "origip=([0-9.]+)", 0, 1, "unknown");
    set $.cleanmsg  = re_replace($msg, "^\\s*\\[origip=[0-9.]+\\]\\s*", "");

    if ($.origip != "unknown") then {
        action(
            type="omfile"
            dynaFile="DynFile"
            template="CeelogJSONClean"
            dirCreateMode="0755"
            fileCreateMode="0644"
        )
        stop
    }
}

# fallback: origip 없거나 추출 실패 시
action(
  type="omfile"
  file="/var/log/plura/ceelog-unknown.log"
  dirCreateMode="0755"
  fileCreateMode="0644"
)
stop
