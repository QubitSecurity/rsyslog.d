module(load="imudp") # needs to be done just once
input(type="imudp" port="514")

template(name="DynFile" type="string"
         string="/var/log/plura/ceelog-%$.origip%.log")

template(name="CeelogJSONClean" type="string"
         string="{\"ceelog\":{\"timegenerated\":\"%timegenerated:::date-rfc3339%\",\"programname\":\"%programname%\",\"hostname\":\"%hostname%\",\"syslogtag\":\"%syslogtag%\",\"pri\":\"%pri%\",\"pri-text\":\"%pri-text%\",\"syslogfacility\":\"%syslogfacility%\",\"syslogfacility-text\":\"%syslogfacility-text%\",\"syslogseverity\":\"%syslogseverity%\",\"syslogseverity-text\":\"%syslogseverity-text%\",\"msg\":\"%$.cleanmsg%\"}}\n")

if $msg contains "origip=" then {
    set $.origip = re_extract($msg, "origip=([0-9.]+)", 0, 1, "unknown");
    set $.cleanmsg = re_extract($msg, "^ ?\\[origip=[0-9.]+\\] ?(.*)", 0, 1, $msg);
    action(
        type="omfile"
        dynaFile="DynFile"
        template="CeelogJSONClean"
    )
    stop
}
